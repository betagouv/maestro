import { XMLParser } from 'fast-xml-parser';
import { SSD2Id } from 'maestro-shared/referential/Residue/SSD2Id';
import { AnalysisMethod } from 'maestro-shared/schema/Analysis/AnalysisMethod';
import { maestroDate } from 'maestro-shared/utils/date';
import { z } from 'zod/v4';
import { ExtractError } from './extractError';
import {
  ExportAnalysis,
  ExportDataFromEmail,
  ExportDataSubstance,
  LaboratoryConf
} from './index';
import { frenchNumberStringValidator } from './utils';

const girpaUnknownReferences: string[] = [
  'DMPF',
  'cyprosulfamide',
  "methoxychlor, o,p'-",
  "methoxychlor, p,p'-",
  'desmethyl-metobromuron',
  'sulfluramid',
  'spinosad according reg.'
];
const girpaReferences: Record<string, SSD2Id> = {
  // Références associées manuellement
  '1-naphthylacetamide and 1-naphthylacetic acid according reg.':
    'RF-00005728-PAR',
  'abamectin according reg.': 'RF-00004655-PAR',
  'aldicarb according reg.': 'RF-0020-001-PPP',
  'aldrin and dieldrin according reg.': 'RF-0021-001-PPP',
  'amitraz according reg.': 'RF-0024-001-PPP',
  'benalaxyl according reg.': 'RF-0038-001-PPP',
  'benthiavalicarb according reg.': 'RF-00004656-PAR',
  'bifenazate according reg.': 'RF-00003033-PAR',
  'bifenthrin according reg.': 'RF-0046-001-PPP',
  bispyribac: 'RF-0507-001-PPP',
  'bitertanol according reg.': 'RF-0048-001-PPP',
  bromoxynil: 'RF-00003327-PAR',
  'bromuconazole according reg.': 'RF-0054-001-PPP',
  'carbendazim and benomyl according reg.': 'RF-0041-001-PPP',
  'carbetamide according reg.': 'RF-00012044-PAR',
  'carbofuran according reg.': 'RF-00003374-PAR',
  'carboxin according reg.': 'RF-00011559-PAR',
  'carfentrazone-ethyl according reg.': 'RF-00012874-PAR',
  'chlordane according reg.': 'RF-0075-005-PPP',
  'chlormequat according reg.': 'RF-00005727-PAR',
  'cinidon-ethyl according reg.': 'RF-0095-001-PPP',
  'clethodim (sum)': 'RF-0096-001-PPP',
  'cyflufenamid according reg.': 'RF-0107-001-PPP',
  'cyfluthrin according reg.': 'RF-0108-001-PPP',
  'cypermethrin according reg.': 'RF-0112-004-PPP',
  'DDT according reg.': 'RF-0119-001-PPP',
  'diclofop according reg.': 'RF-00012875-PAR',
  'dicofol according reg.': 'RF-0130-002-PPP',
  'dimethenamid according reg.': 'RF-0137-002-PPP',
  'dimethomorph according reg.': 'RF-0140-001-PPP',
  'diniconazole according reg.': 'RF-0142-001-PPP',
  'disulfoton according reg.': 'RF-0149-001-PPP',
  'dithiocarbamates according reg.': 'RF-0151-001-PPP',
  'emamectin B1a according reg.': 'RF-0649-001-PPP',
  'endosulfan according reg.': 'RF-0155-001-PPP',
  'fenamiphos according reg.': 'RF-0173-001-PPP',
  'fenbuconazole according reg.': 'RF-00012045-PAR',
  'fenchlorphos according reg.': 'RF-0178-001-PPP',
  'fenpropidin according reg.': 'RF-00007586-PAR',
  'fenpropimorph according reg.': 'RF-0185-001-PPP',
  'fenthion according reg.': 'RF-0187-001-PPP',
  'fenvalerate according reg.': 'RF-00003017-PAR',
  'fipronil according reg.': 'RF-0192-001-PPP',
  'flonicamid according reg.': 'RF-00004683-PAR',
  'fluoxastrobin according reg.': 'RF-0211-001-PPP',
  'folpet according reg.': 'RF-00004687-PAR',
  'formetanate according reg.': 'RF-0223-002-PPP',
  'fosetyl-Al according reg.': 'RF-0225-001-PPP',
  TFNA: 'RF-00003348-PAR',
  TFNG: 'RF-00003349-PAR',
  flucythrinate: 'RF-0201-002-PPP',
  flurochloridone: 'RF-00011881-PAR',
  'halauxifen-methyl according reg.': 'RF-00004666-PAR',
  'heptachlor according reg.': 'RF-0236-001-PPP',
  hexythiazox: 'RF-00013472-PAR',
  'imazamox according reg.': 'RF-0247-001-PPP',
  'indoxacarb according reg.': 'RF-0251-001-PPP',
  'iodosulfuron-methyl according reg.': 'RF-0252-001-PPP',
  ioxynil: 'RF-00011560-PAR',
  'isoxaflutole according reg.': 'RF-0259-001-PPP',
  'lambda cyhalothrine according reg.': 'RF-1004-001-PPP',
  'lufenuron according reg.': 'RF-0265-001-PPP',
  'malathion according reg.': 'RF-0266-001-PPP',
  mandipropamid: 'RF-00012047-PAR',
  'mecoprop according reg.': 'RF-0273-001-PPP',
  'mepiquat according reg.': 'RF-00005721-PAR',
  'meptyldinocap according reg.': 'RF-0276-001-PPP',
  'metaflumizone according reg.': 'RF-00007589-PAR',
  'metalaxyl and metalaxyl-M according reg.': 'RF-0281-001-PPP',
  'metazachlor metabolite 479M08': 'RF-00003324-PAR',
  'metazachlor metabolite 479M04': 'RF-00003323-PAR',
  'metazachlor metabolite 479M16': 'RF-00003325-PAR',
  'metazachlor according reg.': 'RF-00003344-PAR',
  'metconazole according reg.': 'RF-0286-001-PPP',
  'methiocarb according reg.': 'RF-0291-001-PPP',
  'methiocarb sulfoxide': 'RF-0291-003-PPP',
  'metobromuron according reg.': 'RF-00014532-PAR',
  'metolachlor and S-metolachlor according reg.': 'RF-00002611-PAR',
  'mevinphos according reg.': 'RF-00012328-PAR',
  'milbemectin according reg.': 'RF-00003018-PAR',
  'myclobutanil according reg.': 'RF-00012801-PAR',
  'napropamide according reg.': 'RF-00012802-PAR',
  'oxydemeton-methyl according reg.': 'RF-0323-001-PPP',
  paclobutrazol: 'RF-00012043-PAR',
  'parathion-methyl according reg.': 'RF-0328-001-PPP',
  'penconazole according reg.': 'RF-0329-001-PPP',
  'pencycuron according reg.': 'RF-00012803-PAR',
  'permethrin according reg.': 'RF-0842-001-PPP',
  'BTS 44595': 'RF-00003328-PAR',
  'BTS 44596': 'RF-00003329-PAR',
  'prochloraz according reg.': 'RF-00012032-PAR',
  'prohexadione according reg.': 'RF-0352-001-PPP',
  propachlor: 'RF-0353-001-PPP',
  'propamocarb according reg.': 'RF-0354-001-PPP',
  'propiconazole according reg.': 'RF-0358-001-PPP',
  'propoxycarbazone according reg.': 'RF-0362-001-PPP',
  'prothioconazole: prothioconazole-desthio according reg.': 'RF-0868-001-PPP',
  'pyraflufen-ethyl according reg.': 'RF-00003367-PAR',
  'pyrethrins according reg.': 'RF-0374-001-PPP',
  'quintozene according reg.': 'RF-0383-001-PPP',
  'resmethrin according reg.': 'RF-0385-001-PPP',
  'sedaxane according reg.': 'RF-00012869-PAR',
  'spinetoram (XDE-175, sum J and L isomers)': 'RF-00013247-PAR',
  'spirotetramat according reg.': 'RF-00000030-PAR',
  'spirotetramat-enol': 'RF-00012871-PAR',
  'spiroxamine according reg.': 'RF-0397-001-PPP',
  'sulfoxaflor according reg.': 'RF-00004679-PAR',
  'fluvalinate according reg.': 'RF-0402-001-PPP',
  tefluthrin: 'RF-00013463-PAR',
  'tembotrione according reg.': 'RF-00012293-PAR',
  'tolylfluanid according reg.': 'RF-0425-001-PPP',
  'triadimenol according reg.': 'RF-00005717-PAR',
  'triflumizole according reg.': 'RF-0440-001-PPP',
  'triflumizole metabolite FM-6-1': 'RF-00003354-PAR',
  'triflusulfuron (IN-M7222) according reg.': 'RF-00005716-PAR',

  // Références associées automatiquement via le label ou le cas number

  THPI: 'RF-00004686-PAR',
  '1-naphthylacetic acid': 'RF-0007-001-PPP',
  '1-naphthylacetamide': 'RF-0006-001-PPP',
  '2,4-D': 'RF-0010-003-PPP',
  '2,4-DB': 'RF-00004646-PAR',
  '2,4,5-T': 'RF-0009-001-PPP',
  "4,4'-dichlorobenzophenone": 'RF-0605-001-PPP',
  'avermectin B1a': 'RF-0011-003-PPP',
  'avermectin B1b': 'RF-0011-004-PPP',
  'delta-8,9-avermectin B1a': 'RF-0011-002-PPP',
  acephate: 'RF-0012-001-PPP',
  acequinocyl: 'RF-0013-001-PPP',
  acetamiprid: 'RF-0014-001-PPP',
  acetochlor: 'RF-0015-001-PPP',
  'acibenzolar-S-methyl': 'RF-0016-002-PPP',
  'gibberellic acid': 'RF-0230-001-PPP',
  aclonifen: 'RF-0017-001-PPP',
  acrinathrin: 'RF-0018-001-PPP',
  alachlor: 'RF-0019-001-PPP',
  aldicarb: 'RF-0020-002-PPP',
  'aldicarb sulfone': 'RF-0020-004-PPP',
  'aldicarb sulfoxide': 'RF-0020-003-PPP',
  aldrin: 'RF-0021-002-PPP',
  dieldrin: 'RF-0021-003-PPP',
  ametoctradin: 'RF-1055-001-PPP',
  ametryn: 'RF-0467-001-PPP',
  amidosulfuron: 'RF-0022-001-PPP',
  amisulbrom: 'RF-0470-001-PPP',
  amitraz: 'RF-0024-002-PPP',
  'DMA (2,4-dimethylaniline)': 'RF-0992-001-PPP',
  DMF: 'RF-0024-003-PPP',
  anilazine: 'RF-0026-001-PPP',
  anthraquinone: 'RF-0475-001-PPP',
  asulam: 'RF-0028-001-PPP',
  atrazine: 'RF-0029-001-PPP',
  azaconazole: 'RF-0482-001-PPP',
  azadirachtin: 'RF-0030-001-PPP',
  azamethiphos: 'RF-0484-001-PPP',
  azimsulfuron: 'RF-0031-001-PPP',
  'azinphos-ethyl': 'RF-0032-001-PPP',
  'azinphos-methyl': 'RF-0033-001-PPP',
  azoxystrobin: 'RF-0035-001-PPP',
  beflubutamid: 'RF-0037-001-PPP',
  bendiocarb: 'RF-0489-001-PPP',
  benfluralin: 'RF-0039-001-PPP',
  benoxacor: 'RF-0492-001-PPP',
  'bensulfuron-methyl': 'RF-0494-001-PPP',
  bentazone: 'RF-0042-002-PPP',
  '6-hydroxy bentazone': 'RF-0042-004-PPP',
  '8-hydroxy bentazone': 'RF-0042-003-PPP',
  benzovindiflupyr: 'RF-00003386-PAR',
  benzoximate: 'RF-0500-001-PPP',
  '6-benzyladenine': 'RF-1062-001-PPP',
  bifenazate: 'RF-0044-001-PPP',
  'bifenazate-diazene': 'RF-00003032-PAR',
  bifenox: 'RF-0045-001-PPP',
  biphenyl: 'RF-0506-001-PPP',
  bixafen: 'RF-1056-001-PPP',
  boscalid: 'RF-0049-001-PPP',
  bromacil: 'RF-0511-001-PPP',
  bromadiolone: 'RF-00002596-PAR',
  'bromophos-ethyl': 'RF-0051-001-PPP',
  'bromophos-methyl': 'RF-0517-001-PPP',
  bromopropylate: 'RF-0052-001-PPP',
  bupirimate: 'RF-0055-001-PPP',
  buprofezin: 'RF-0056-001-PPP',
  butachlor: 'RF-0519-001-PPP',
  butralin: 'RF-0057-001-PPP',
  buturon: 'RF-0527-001-PPP',
  cadusafos: 'RF-0528-001-PPP',
  carbaryl: 'RF-0062-001-PPP',
  carbendazim: 'RF-0041-002-PPP',
  benomyl: 'RF-0041-003-PPP',
  carbophenothion: 'RF-0535-001-PPP',
  carbofuran: 'RF-0065-003-PPP',
  '3-OH carbofuran': 'RF-0065-002-PPP',
  benfuracarb: 'RF-0040-001-PPP',
  carbosulfan: 'RF-0068-001-PPP',
  furathiocarb: 'RF-0228-001-PPP',
  carboxin: 'RF-0069-001-PPP',
  'carboxin sulfoxide': 'RF-00005982-PAR',
  oxycarboxin: 'RF-0322-001-PPP',
  'carfentrazone-ethyl': 'RF-0070-003-PPP',
  carfentrazone: 'RF-0070-002-PPP',
  chinomethionat: 'RF-0539-001-PPP',
  chlorantraniliprole: 'RF-0072-001-PPP',
  chlorbufam: 'RF-0074-001-PPP',
  'cis-chlordane': 'RF-0075-004-PPP',
  'trans-chlordane': 'RF-0075-003-PPP',
  oxychlordane: 'RF-0827-001-PPP',
  chlordimeform: 'RF-0545-001-PPP',
  chlorfenapyr: 'RF-0077-001-PPP',
  chlorfenson: 'RF-0078-001-PPP',
  chlorfenvinphos: 'RF-0079-001-PPP',
  chlorfluazuron: 'RF-0549-001-PPP',
  chloridazon: 'RF-0080-001-PPP',
  chlormephos: 'RF-0554-001-PPP',
  chlorobenzilate: 'RF-0082-001-PPP',
  '4-CPA': 'RF-0460-001-PPP',
  chlorothalonil: 'RF-0084-001-PPP',
  chlorotoluron: 'RF-0092-001-PPP',
  chloroxuron: 'RF-0085-001-PPP',
  chlorpropham: 'RF-0086-003-PPP',
  chlorpyrifos: 'RF-0087-001-PPP',
  'chlorpyrifos-methyl': 'RF-0088-001-PPP',
  'desmethyl chlorpyrifos-methyl': 'RF-00009870-PAR',
  chlorsulfuron: 'RF-0089-001-PPP',
  'chlorthal-dimethyl': 'RF-0090-001-PPP',
  chlorthiophos: 'RF-0561-001-PPP',
  chromafenozide: 'RF-0094-001-PPP',
  clethodim: 'RF-0096-005-PPP',
  'clethodim sulfone': 'RF-0096-002-PPP',
  'clethodim sulfoxide': 'RF-0096-004-PPP',
  sethoxydim: 'RF-0096-003-PPP',
  'clodinafop-propargyl': 'RF-0565-001-PPP',
  clofentezine: 'RF-0098-001-PPP',
  clomazone: 'RF-0099-001-PPP',
  clopyralid: 'RF-0100-001-PPP',
  'cloquintocet mexyl': 'RF-0568-001-PPP',
  clothianidin: 'RF-0101-001-PPP',
  coumaphos: 'RF-0571-001-PPP',
  cyanazine: 'RF-0576-001-PPP',
  cyantraniliprole: 'RF-00003336-PAR',
  cyazofamid: 'RF-0104-001-PPP',
  cycloxydim: 'RF-0106-002-PPP',
  cyflumetofen: 'RF-00002591-PAR',
  'cyhalofop-butyl': 'RF-00003378-PAR',
  cymiazole: 'RF-0586-001-PPP',
  cymoxanil: 'RF-0111-001-PPP',
  cyproconazole: 'RF-0113-001-PPP',
  cyprodinil: 'RF-0114-001-PPP',
  cyromazine: 'RF-0115-001-PPP',
  dazomet: 'RF-0118-003-PPP',
  "p,p'-DDE": 'RF-0119-002-PPP',
  "o,p'-DDT": 'RF-0119-003-PPP',
  "p,p'-DDT": 'RF-0119-006-PPP',
  "p,p'-TDE (DDD)": 'RF-0119-004-PPP',
  'DEET (N,N-diethyl-3-methylbenzamide)': 'RF-0616-001-PPP',
  deltamethrin: 'RF-0120-001-PPP',
  'demeton-S-methyl': 'RF-0594-002-PPP',
  desmedipham: 'RF-0121-001-PPP',
  diafenthiuron: 'RF-0596-001-PPP',
  dialifos: 'RF-0597-001-PPP',
  'di-allate (sum)': 'RF-0122-001-PPP',
  diazinon: 'RF-0123-001-PPP',
  dicamba: 'RF-0124-001-PPP',
  dichlobenil: 'RF-0125-001-PPP',
  dichlofenthion: 'RF-0599-001-PPP',
  dichlofluanid: 'RF-0453-001-PPP',
  dichlormid: 'RF-0601-001-PPP',
  '3,5-dichloroaniline': 'RF-0450-002-PPP',
  dichlorprop: 'RF-0126-002-PPP',
  dichlorvos: 'RF-0127-001-PPP',
  'diclofop-methyl': 'RF-0128-003-PPP',
  'diclofop acid': 'RF-0128-002-PPP',
  dicloran: 'RF-0129-001-PPP',
  dicrotophos: 'RF-0612-001-PPP',
  diethofencarb: 'RF-0132-001-PPP',
  difenoconazole: 'RF-0133-001-PPP',
  diflubenzuron: 'RF-0134-001-PPP',
  diflufenican: 'RF-0135-001-PPP',
  dimefox: 'RF-0622-001-PPP',
  dimefuron: 'RF-0623-001-PPP',
  dimethachlor: 'RF-0136-001-PPP',
  dimethoate: 'RF-0139-003-PPP',
  '1,4-dimethylnaphthalene': 'RF-00004728-PAR',
  dimethylvinphos: 'RF-0627-001-PPP',
  dimoxystrobin: 'RF-0141-001-PPP',
  dinoseb: 'RF-0144-001-PPP',
  dinotefuran: 'RF-0633-001-PPP',
  diphenylamine: 'RF-0147-001-PPP',
  disulfoton: 'RF-0149-002-PPP',
  'disulfoton sulfone': 'RF-0149-004-PPP',
  'disulfoton sulfoxide': 'RF-0149-003-PPP',
  ditalimfos: 'RF-0640-001-PPP',
  dithianon: 'RF-0150-001-PPP',
  diuron: 'RF-0152-002-PPP',
  DNOC: 'RF-0153-001-PPP',
  dodemorph: 'RF-0645-001-PPP',
  dodine: 'RF-0154-001-PPP',
  'endosulfan-alpha': 'RF-0155-004-PPP',
  'endosulfan-beta': 'RF-0155-003-PPP',
  'endosulfan-sulphate': 'RF-0155-002-PPP',
  endrin: 'RF-0156-001-PPP',
  EPN: 'RF-0654-001-PPP',
  epoxiconazole: 'RF-0157-001-PPP',
  EPTC: 'RF-0158-001-PPP',
  esprocarb: 'RF-0656-001-PPP',
  'ethametsulfuron-methyl': 'RF-0658-001-PPP',
  ethephon: 'RF-0160-001-PPP',
  ethidimuron: 'RF-0659-001-PPP',
  ethiofencarb: 'RF-0660-001-PPP',
  ethion: 'RF-0161-001-PPP',
  ethiprole: 'RF-0664-001-PPP',
  ethirimol: 'RF-0162-001-PPP',
  ethofumesate: 'RF-0163-002-PPP',
  ethoprophos: 'RF-0164-001-PPP',
  etofenprox: 'RF-0168-001-PPP',
  etoxazole: 'RF-0169-001-PPP',
  etridiazole: 'RF-0170-001-PPP',
  etrimfos: 'RF-0668-001-PPP',
  famoxadone: 'RF-0171-001-PPP',
  fenamidone: 'RF-0172-001-PPP',
  fenamiphos: 'RF-0173-004-PPP',
  'fenamiphos sulphone': 'RF-0173-003-PPP',
  'fenamiphos sulphoxide': 'RF-0173-002-PPP',
  fenarimol: 'RF-0174-001-PPP',
  fenazaquin: 'RF-0175-001-PPP',
  'fenchlorazole-ethyl': 'RF-0673-001-PPP',
  fenchlorphos: 'RF-0178-002-PPP',
  'fenchlorphos oxon': 'RF-0178-003-PPP',
  fenhexamid: 'RF-0179-001-PPP',
  fenitrothion: 'RF-0180-001-PPP',
  fenobucarb: 'RF-0677-001-PPP',
  'fenoxaprop-P': 'RF-0181-001-PPP',
  'fenoxaprop-P-ethyl': 'RF-0681-001-PPP',
  fenoxycarb: 'RF-0182-001-PPP',
  fenpicoxamid: 'RF-00010217-PAR',
  fenpropathrin: 'RF-0183-001-PPP',
  fenpyrazamine: 'RF-00002610-PAR',
  fenpyroximate: 'RF-0186-001-PPP',
  fensulfothion: 'RF-0685-002-PPP',
  'fensulfothion-sulfone': 'RF-0685-003-PPP',
  'fensulfothion-oxon': 'RF-0685-004-PPP',
  'fensulfothion-oxon-sulfone': 'RF-0685-005-PPP',
  fenthion: 'RF-0187-006-PPP',
  'fenthion sulfone': 'RF-0187-003-PPP',
  'fenthion sulfoxide': 'RF-0187-002-PPP',
  'fenthion-oxon': 'RF-0187-004-PPP',
  'fenthion-oxon-sulfone': 'RF-0187-007-PPP',
  'fenthion-oxon-sulfoxide': 'RF-0187-005-PPP',
  fenuron: 'RF-0689-001-PPP',
  fipronil: 'RF-0192-003-PPP',
  'fipronil sulfone (MB46136)': 'RF-0192-002-PPP',
  'fipronil-desulfinyl': 'RF-0692-002-PPP',
  flazasulfuron: 'RF-0193-001-PPP',
  flonicamid: 'RF-0194-002-PPP',
  florasulam: 'RF-0195-001-PPP',
  'florpyrauxifen-benzyl': 'RF-00010416-PAR',
  'fluazifop-P': 'RF-0698-001-PPP',
  'fluazifop-P-butyl': 'RF-0197-002-PPP',
  fluazinam: 'RF-0198-001-PPP',
  flubendiamide: 'RF-0199-001-PPP',
  fludioxonil: 'RF-0202-001-PPP',
  fluensulfone: 'RF-00011591-PAR',
  flufenacet: 'RF-0203-002-PPP',
  flufenoxuron: 'RF-0204-001-PPP',
  flumethrin: 'RF-0705-001-PPP',
  flumetralin: 'RF-0706-001-PPP',
  flumioxazine: 'RF-0206-001-PPP',
  fluometuron: 'RF-0207-001-PPP',
  fluopicolide: 'RF-0208-001-PPP',
  fluopyram: 'RF-1071-001-PPP',
  fluotrimazole: 'RF-0713-001-PPP',
  flupyradifurone: 'RF-00004662-PAR',
  'flupyrsulfuron-methyl': 'RF-0212-001-PPP',
  fluquinconazole: 'RF-0213-001-PPP',
  fluroxypyr: 'RF-0215-003-PPP',
  flurtamone: 'RF-0217-001-PPP',
  flusilazole: 'RF-0218-001-PPP',
  flutianil: 'RF-00008904-PAR',
  flutolanil: 'RF-0219-001-PPP',
  flutriafol: 'RF-0220-001-PPP',
  fluxapyroxad: 'RF-00000024-PAR',
  folpet: 'RF-0221-001-PPP',
  phtalimide: 'RF-0991-001-PPP',
  fomesafen: 'RF-0723-001-PPP',
  fonofos: 'RF-0724-001-PPP',
  foramsulfuron: 'RF-0222-001-PPP',
  forchlorfenuron: 'RF-0196-001-PPP',
  formothion: 'RF-0224-001-PPP',
  fosthiazate: 'RF-0226-001-PPP',
  fosetyl: 'RF-1059-001-PPP',
  fuberidazole: 'RF-0227-001-PPP',
  furalaxyl: 'RF-0727-001-PPP',
  glyphosate: 'RF-1020-001-PPP',
  halauxifen: 'RF-00004665-PAR',
  'halauxifen-methyl': 'RF-00007584-PAR',
  'halosulfuron methyl': 'RF-0234-001-PPP',
  haloxyfop: 'RF-0235-004-PPP',
  'haloxyfop methyl': 'RF-0235-002-PPP',
  'haloxyfop-2-ethoxyethyl': 'RF-0235-003-PPP',
  heptachlor: 'RF-0236-004-PPP',
  'heptachlore epoxide cis': 'RF-0236-005-PPP',
  'heptachlore epoxide trans': 'RF-0236-005-PPP',
  heptenophos: 'RF-0737-001-PPP',
  hexachlorobenzene: 'RF-0237-001-PPP',
  'hexachlorocyclohexane alpha': 'RF-0238-001-PPP',
  'hexachlorocyclohexane beta': 'RF-0239-002-PPP',
  'hexachlorocyclohexane delta': 'RF-0736-001-PPP',
  'hexachlorocyclohexane epsilon': 'RF-0240-004-PPP',
  hexaconazole: 'RF-0241-001-PPP',
  hexaflumuron: 'RF-0738-001-PPP',
  hexazinone: 'RF-0739-001-PPP',
  hymexazol: 'RF-0245-001-PPP',
  imazalil: 'RF-0246-001-PPP',
  imazapyr: 'RF-0744-001-PPP',
  imazaquin: 'RF-0248-001-PPP',
  imazethapyr: 'RF-0745-001-PPP',
  imazosulfuron: 'RF-0249-001-PPP',
  imidaclopride: 'RF-0250-001-PPP',
  inabenfide: 'RF-0750-001-PPP',
  'indolylbutyric acid': 'RF-00004668-PAR',
  ipconazole: 'RF-0254-001-PPP',
  iprobenfos: 'RF-0751-001-PPP',
  iprodione: 'RF-0255-001-PPP',
  iprovalicarb: 'RF-0256-001-PPP',
  isazofos: 'RF-0752-001-PPP',
  isocarbophos: 'RF-0754-001-PPP',
  isofenphos: 'RF-0756-001-PPP',
  'isofenphos-methyl': 'RF-0758-001-PPP',
  isofetamid: 'RF-00007585-PAR',
  isoprocarb: 'RF-0762-001-PPP',
  isoprothiolane: 'RF-0764-001-PPP',
  isoproturon: 'RF-0257-001-PPP',
  isopyrazam: 'RF-00000025-PAR',
  isoxaben: 'RF-0258-001-PPP',
  'isoxadifen-ethyl': 'RF-0765-001-PPP',
  isoxaflutole: 'RF-0259-002-PPP',
  'isoxaflutole diketonitrile-metabolite': 'RF-00004677-PAR',
  karanjin: 'RF-00011191-PAR',
  'kresoxim-methyl': 'RF-0260-001-PPP',
  lenacil: 'RF-0262-001-PPP',
  'lindane (HCH-gamma)': 'RF-0263-001-PPP',
  linuron: 'RF-0264-001-PPP',
  malathion: 'RF-0266-003-PPP',
  malaoxon: 'RF-0266-002-PPP',
  'maleic hydrazid': 'RF-0267-001-PPP',
  mandestrobin: 'RF-00004671-PAR',
  MCPA: 'RF-0271-005-PPP',
  MCPB: 'RF-0271-002-PPP',
  mecarbam: 'RF-0272-001-PPP',
  mefenacet: 'RF-0776-001-PPP',
  'mefenpyr-diethyl': 'RF-00000026-PAR',
  mefentrifluconazole: 'RF-00009360-PAR',
  mefluidide: 'RF-0778-001-PPP',
  mepanipyrim: 'RF-0274-002-PPP',
  mepronil: 'RF-0780-001-PPP',
  'meptyldinocap  (2,4-DNOPC)': 'RF-00002838-PAR',
  '2,4 DNOP': 'RF-00004644-PAR',
  'mesosulfuron-methyl': 'RF-0278-003-PPP',
  mesotrione: 'RF-00003357-PAR',
  metaldehyde: 'RF-0282-001-PPP',
  metamitron: 'RF-0284-001-PPP',
  metazachlor: 'RF-0285-001-PPP',
  methabenzthiazuron: 'RF-0287-001-PPP',
  methacrifos: 'RF-0288-001-PPP',
  methamidophos: 'RF-0289-001-PPP',
  methidathion: 'RF-0290-001-PPP',
  methiocarb: 'RF-0291-002-PPP',
  'methiocarb sulfone': 'RF-0291-004-PPP',
  methomyl: 'RF-0293-003-PPP',
  methoprotryne: 'RF-0786-001-PPP',
  "methoxychlor (sum o,p' and p,p')": 'RF-0295-001-PPP',
  methoxyfenozide: 'RF-0296-001-PPP',
  metobromuron: 'RF-0791-001-PPP',
  '4-bromophenylurea': 'RF-00003387-PAR',
  metosulam: 'RF-0298-001-PPP',
  metoxuron: 'RF-0794-001-PPP',
  metrafenone: 'RF-0299-001-PPP',
  metribuzin: 'RF-0300-001-PPP',
  'metsulfuron-methyl': 'RF-0301-001-PPP',
  'milbemycin A3': 'RF-0303-002-PPP',
  'milbemycin A4': 'RF-0303-003-PPP',
  mirex: 'RF-0797-001-PPP',
  molinate: 'RF-0304-001-PPP',
  monocrotophos: 'RF-0305-001-PPP',
  monolinuron: 'RF-0306-001-PPP',
  naled: 'RF-0800-001-PPP',
  neburon: 'RF-0805-001-PPP',
  nicosulfuron: 'RF-0310-001-PPP',
  nitenpyram: 'RF-0810-001-PPP',
  nitrofen: 'RF-0311-001-PPP',
  norflurazon: 'RF-0312-001-PPP',
  novaluron: 'RF-0313-001-PPP',
  nuarimol: 'RF-0819-001-PPP',
  ofurace: 'RF-0821-001-PPP',
  omethoate: 'RF-0139-002-PPP',
  '2-phenylphenol': 'RF-0823-001-PPP',
  oryzalin: 'RF-0316-001-PPP',
  oxadiargyl: 'RF-0317-001-PPP',
  oxadiazon: 'RF-0318-001-PPP',
  oxadixyl: 'RF-0319-001-PPP',
  oxamyl: 'RF-0320-001-PPP',
  oxasulfuron: 'RF-0321-001-PPP',
  oxathiapiprolin: 'RF-00008949-PAR',
  'oxydemeton-methyl': 'RF-0323-004-PPP',
  'demeton-S-methylsulfone': 'RF-0323-003-PPP',
  oxyfluorfen: 'RF-0324-001-PPP',
  'parathion-ethyl': 'RF-0327-001-PPP',
  'paraoxon-ethyl': 'RF-0828-001-PPP',
  'parathion-methyl': 'RF-0328-003-PPP',
  'paraoxon-methyl': 'RF-0328-002-PPP',
  penconazole: 'RF-0329-001-PPP',
  pencycuron: 'RF-0330-001-PPP',
  'pencycuron-PB-amine': 'RF-00012804-PAR',
  pendimethalin: 'RF-0331-001-PPP',
  penflufen: 'RF-00003362-PAR',
  penoxsulam: 'RF-0332-001-PPP',
  pentachloroanisole: 'RF-0837-001-PPP',
  'pentachlorophenylsulfur-methyl': 'RF-1038-001-PPP',
  penthiopyrad: 'RF-00002609-PAR',
  pethoxamid: 'RF-0333-001-PPP',
  phenmedipham: 'RF-0334-001-PPP',
  phenthoate: 'RF-0846-001-PPP',
  phorate: 'RF-0336-003-PPP',
  'phorate oxon': 'RF-0336-005-PPP',
  'phorate oxon sulfone': 'RF-0336-006-PPP',
  'phorate oxon sulfoxide': 'RF-0336-007-PPP',
  phosalone: 'RF-0337-001-PPP',
  phosmet: 'RF-0338-002-PPP',
  'phosmet oxon': 'RF-0338-003-PPP',
  phosphamidon: 'RF-0339-001-PPP',
  'phosphonic acid': 'RF-00004675-PAR',
  'phosphonic acid according reg.': 'RF-00004675-PAR',
  phoxim: 'RF-0342-001-PPP',
  picloram: 'RF-0343-001-PPP',
  picolinafen: 'RF-0344-001-PPP',
  picoxystrobin: 'RF-0345-001-PPP',
  pinoxaden: 'RF-0346-001-PPP',
  'piperonyl butoxide': 'RF-0848-001-PPP',
  pirimicarb: 'RF-0347-002-PPP',
  'pirimiphos ethyl': 'RF-0851-001-PPP',
  pretilachlor: 'RF-0854-001-PPP',
  'pirimiphos-methyl': 'RF-0348-001-PPP',
  'N-desethyl-pirimiphos-methyl': 'RF-00000028-PAR',
  prochloraz: 'RF-0349-002-PPP',
  procymidone: 'RF-0350-001-PPP',
  profenofos: 'RF-0351-001-PPP',
  profluraline: 'RF-0858-001-PPP',
  profoxydim: 'RF-0859-001-PPP',
  prometryn: 'RF-0862-001-PPP',
  propanil: 'RF-0355-001-PPP',
  propaquizafop: 'RF-0356-001-PPP',
  propargite: 'RF-0357-001-PPP',
  propazine: 'RF-0864-001-PPP',
  propham: 'RF-0867-001-PPP',
  propoxur: 'RF-0361-001-PPP',
  propoxycarbazone: 'RF-0362-002-PPP',
  '2-hydroxypropoxycarbazone': 'RF-00004648-PAR',
  propyzamide: 'RF-0364-001-PPP',
  proquinazid: 'RF-0365-001-PPP',
  prosulfocarb: 'RF-0366-001-PPP',
  prosulfuron: 'RF-0367-001-PPP',
  prothiofos: 'RF-0869-001-PPP',
  pydiflumetofen: 'RF-00009486-PAR',
  pymetrozine: 'RF-0369-001-PPP',
  pyraclostrobin: 'RF-0370-001-PPP',
  pyraflufen: 'RF-00003366-PAR',
  'pyraflufen-ethyl': 'RF-0371-001-PPP',
  pyrazophos: 'RF-0373-001-PPP',
  'pyrethrin I': 'RF-0374-002-PPP',
  'pyrethrin II': 'RF-0374-003-PPP',
  'cinerine I': 'RF-1066-002-PPP',
  'cinerine II': 'RF-1066-003-PPP',
  'jasmolin I': 'RF-0374-004-PPP',
  'jasmolin II': 'RF-0374-005-PPP',
  pyridaben: 'RF-0375-001-PPP',
  pyridaphenthion: 'RF-0877-001-PPP',
  pyridalyl: 'RF-0876-001-PPP',
  pyridate: 'RF-0376-002-PPP',
  pyrifenox: 'RF-0878-001-PPP',
  pyrimethanil: 'RF-0377-001-PPP',
  pyriofenone: 'RF-00003031-PAR',
  pyriproxyfen: 'RF-0378-001-PPP',
  pyroquilon: 'RF-0379-001-PPP',
  pyroxsulam: 'RF-0883-001-PPP',
  quinalphos: 'RF-0380-001-PPP',
  quinmerac: 'RF-0381-001-PPP',
  quinoclamine: 'RF-0886-001-PPP',
  quinoxyfen: 'RF-0382-001-PPP',
  quintozene: 'RF-0383-002-PPP',
  'pentachloro-aniline': 'RF-0383-003-PPP',
  quizalofop: 'RF-0384-004-PPP',
  'quizalofop-ethyl': 'RF-0887-001-PPP',
  rimsulfuron: 'RF-0386-001-PPP',
  rotenone: 'RF-0387-001-PPP',
  'S-421': 'RF-0889-001-PPP',
  silthiofam: 'RF-0389-001-PPP',
  simazine: 'RF-0390-001-PPP',
  sintofen: 'RF-00001606-PAR',
  'spinetoram J': 'RF-00010375-PAR',
  'spinetoram L': 'RF-00009240-PAR',
  'spinosyn A': 'RF-0393-002-PPP',
  'spinosyn D': 'RF-0393-003-PPP',
  spirodiclofen: 'RF-0394-001-PPP',
  spiromesifen: 'RF-0395-001-PPP',
  spirotetramat: 'RF-00003368-PAR',
  sulcotrione: 'RF-0398-001-PPP',
  sulfentrazone: 'RF-0901-001-PPP',
  sulfosulfuron: 'RF-0399-001-PPP',
  sulfotep: 'RF-0903-001-PPP',
  sulprofos: 'RF-0905-001-PPP',
  tebuconazole: 'RF-0403-001-PPP',
  tebufenozide: 'RF-0404-001-PPP',
  tebufenpyrad: 'RF-0405-001-PPP',
  tebupirimfos: 'RF-0907-001-PPP',
  tebutam: 'RF-0908-001-PPP',
  tecnazene: 'RF-0406-001-PPP',
  teflubenzuron: 'RF-0407-001-PPP',
  tembotrione: 'RF-0409-001-PPP',
  '4,6-dihydroxy tembotrione': 'RF-00002608-PAR',
  tepraloxydim: 'RF-0411-001-PPP',
  terbacil: 'RF-0912-001-PPP',
  terbufos: 'RF-0412-002-PPP',
  'terbufos sulfone': 'RF-0412-003-PPP',
  'terbufos sulfoxyde': 'RF-0412-004-PPP',
  terbuthylazine: 'RF-0413-001-PPP',
  terbutryn: 'RF-0919-001-PPP',
  tetrachlorvinphos: 'RF-0920-001-PPP',
  tetraconazole: 'RF-0414-001-PPP',
  tetradifon: 'RF-0415-001-PPP',
  tetramethrin: 'RF-0922-001-PPP',
  thiabendazole: 'RF-0416-001-PPP',
  thiacloprid: 'RF-0417-001-PPP',
  thiamethoxam: 'RF-0418-001-PPP',
  'thiencarbazone methyl': 'RF-00002593-PAR',
  'thifensulfuron-methyl': 'RF-0419-001-PPP',
  thiocyclam: 'RF-0932-001-PPP',
  thiodicarb: 'RF-0293-002-PPP',
  thiometon: 'RF-0936-001-PPP',
  thionazin: 'RF-0937-001-PPP',
  'thiophanate-methyl': 'RF-0422-001-PPP',
  'tolclofos-methyl': 'RF-0424-001-PPP',
  tolfenpyrad: 'RF-0943-001-PPP',
  tolylfluanid: 'RF-0425-002-PPP',
  dimethylaminosulfotoluidide: 'RF-0644-001-PPP',
  transfluthrin: 'RF-0945-001-PPP',
  triadimefon: 'RF-0428-003-PPP',
  'tri-allate': 'RF-0430-001-PPP',
  triasulfuron: 'RF-0431-001-PPP',
  triazamate: 'RF-0948-001-PPP',
  triazophos: 'RF-0432-001-PPP',
  'tribenuron-methyl': 'RF-0434-001-PPP',
  trichlorfon: 'RF-0435-001-PPP',
  trichloronat: 'RF-0957-001-PPP',
  triclopyr: 'RF-0436-001-PPP',
  tricyclazole: 'RF-0437-001-PPP',
  trifloxystrobin: 'RF-0439-001-PPP',
  trifloxysulfuron: 'RF-0960-001-PPP',
  triflumizole: 'RF-0440-002-PPP',
  triflumuron: 'RF-0441-001-PPP',
  trifluralin: 'RF-0442-001-PPP',
  triforine: 'RF-0444-001-PPP',
  triticonazole: 'RF-0447-001-PPP',
  tritosulfuron: 'RF-0448-001-PPP',
  valifenalate: 'RF-1057-001-PPP',
  vamidothion: 'RF-0969-001-PPP',
  vinclozolin: 'RF-0450-003-PPP',
  zoxamide: 'RF-0452-001-PPP'
};

const codeMethods = ['M1', 'M26', 'M3', 'M18', 'M21', 'M23', 'M27'] as const;
const codeMethodsAnalyseMethod = {
  M1: 'Multi',
  M26: 'Multi',
  M3: 'Mono',
  M18: 'Mono',
  M21: 'Mono',
  M23: 'Mono',
  M27: 'Mono'
} as const satisfies Record<(typeof codeMethods)[number], AnalysisMethod>;
const isCodeMethod = (code: string): code is (typeof codeMethods)[number] =>
  (codeMethods as Readonly<string[]>).includes(code);

const residueCasNumberValidator = z.string().brand('CAS number');

const residueEnglishNameValidator = z.string().brand('ResidueEnglishName');

export const analyseXmlValidator = z.object({
  Résultat: frenchNumberStringValidator,
  Limite_de_quantification: frenchNumberStringValidator,
  LMR: z
    .union([z.literal('-'), z.number(), frenchNumberStringValidator])
    .transform((a) => (a === '-' ? 0 : a)),
  Substance_active_CAS: residueCasNumberValidator,
  Substance_active_anglais: residueEnglishNameValidator,
  //'16/04/2025 21:09:28'
  Date_analyse: z
    .string()
    .regex(/^\d{2}\/\d{2}\/\d{4}.*/)
    .transform((date) => {
      const [d, m, y] = date.substring(0, 10).split('/');
      return `${y}-${m}-${d}`;
    })
    .pipe(maestroDate),
  Code_méthode: z
    .string()
    .transform((s) => (s.endsWith('*') ? s.substring(0, s.length - 1) : s))
    .refine((s) => isCodeMethod(s) || s === '-')
});

export const girpaCodeEchantillonValidator = z.string().transform((l) => {
  const result = l
    .trim()
    .substring(0, l.length - 2)
    .trim()
    .replaceAll(' ', '-');

  if (result.endsWith('-')) {
    return result.substring(0, result.length - 1);
  }
  return result;
});

type GirpaAnaysis = Omit<ExportAnalysis, 'pdfFile'> & {
  girpaReference: string;
};
// Visible for testing
export const extractAnalyzes = (obj: unknown): GirpaAnaysis[] => {
  const echantillonValidator = z.object({
    Code_échantillon: z.string(),
    Commentaire: z.string(),
    Analyse: z.array(analyseXmlValidator)
  });
  const validator = z.object({
    Rapport: z.object({
      Echantillon: z.union([
        echantillonValidator.transform((e) => [e]),
        z.array(echantillonValidator)
      ])
    })
  });

  const result = validator.parse(obj);

  return result.Rapport.Echantillon.map((echantillon) => {
    const residues: ExportDataSubstance[] = echantillon.Analyse.filter(
      (a) => a.Substance_active_anglais !== 'impression étiquettes'
    ).map((a) => {
      const isND = a.Résultat < a.Limite_de_quantification / 3;
      const isNQ = !isND && a.Résultat < a.Limite_de_quantification;

      if (a.Code_méthode === '-') {
        throw new ExtractError(
          `Le code méthode est incorrect, la valeur « - » est réservée pour l'entête`
        );
      }

      const commonData = {
        analysisMethod:
          codeMethodsAnalyseMethod[
            a.Code_méthode as (typeof codeMethods)[number]
          ],
        codeSandre: null,
        casNumber: a.Substance_active_CAS,
        label: a.Substance_active_anglais,
        analysisDate: a.Date_analyse
      };
      return isNQ || isND
        ? {
            result_kind: isND ? 'ND' : 'NQ',
            ...commonData
          }
        : { result_kind: 'Q', result: a.Résultat, lmr: a.LMR, ...commonData };
    });
    return {
      sampleReference: girpaCodeEchantillonValidator.parse(
        echantillon['Code_échantillon']
      ),
      girpaReference: echantillon['Code_échantillon'],
      notes: echantillon.Commentaire,
      residues
    };
  });
};

const exportDataFromEmail: ExportDataFromEmail = (email) => {
  const xmlFile = email.attachments.find(
    ({ contentType }) =>
      contentType === 'text/xml' || contentType === 'application/xml'
  );

  if (xmlFile !== undefined) {
    const parser = new XMLParser();
    const obj = parser.parse(xmlFile.content);

    const analyzes = extractAnalyzes(obj);

    const analyzesWithPdf: ExportAnalysis[] = [];

    for (const analysis of analyzes) {
      const pdfAttachment = email.attachments.find(
        ({ contentType, filename }) =>
          contentType === 'application/pdf' &&
          filename?.startsWith(analysis.girpaReference)
      );

      if (pdfAttachment === undefined) {
        throw new ExtractError(
          `Aucun fichier pdf pour ${analysis.sampleReference}`
        );
      }

      const pdfFile: File = new File(
        [pdfAttachment.content],
        pdfAttachment.filename ?? ''
      );
      analyzesWithPdf.push({ ...analysis, pdfFile });
    }

    return analyzesWithPdf;
  } else {
    throw new ExtractError('Pas de fichier XML dans les pièces jointes');
  }
};

export const girpaConf: LaboratoryConf = {
  exportDataFromEmail,
  ssd2IdByLabel: girpaReferences,
  unknownReferences: girpaUnknownReferences
};
